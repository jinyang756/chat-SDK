<!doctype html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 基本设置 -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>客服系统</title>
    
    <!-- 优先引入Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <!-- PWA设置 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- 性能优化 -->
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <meta name="format-detection" content="telephone=no">
    
    <!-- DNS预解析 -->
    <link rel="dns-prefetch" href="//mdclink.xianshangkefu.com">
    
    <!-- 提前建立连接 -->
    <link rel="preconnect" href="//mdclink.xianshangkefu.com" crossorigin>
</head>
<body>
    <script type="text/javascript">
        // 保留原客服链接代码不变
        window._MICHAT = window._MICHAT || function () { (_MICHAT.a = _MICHAT.a || []).push(arguments) };
        _MICHAT("cptid", "e773425b58e01513a5"); 
        _MICHAT("host", "mdclink.xianshangkefu.com"); 
        (function (m, d, q, j, s) { 
            j = d.createElement(q),s = d.getElementsByTagName(q)[0]; 
            j.async = true; 
            j.charset ="UTF-8"; 
            j.src = ("https:" == document.location.protocol ? "https://" : "http://") + "mdclink.xianshangkefu.com/Web/js/loader.js"; 
            s.parentNode.insertBefore(j, s); 
        })(window, document, "script");
    </script>
    
    <!-- 引入pwa-install组件 -->
    <script src="https://unpkg.com/pwa-install/dist/pwa-install.min.js"></script>
    
    <!-- 备用方案：如果pwa-install不可用，使用备用CDN -->
    <script>if (typeof customElements.get('pwa-install') === 'undefined') {
        console.log('pwa-install组件加载失败，尝试备用CDN');
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/pwa-install/dist/pwa-install.min.js';
        document.head.appendChild(script);
        script.onload = function() {
            console.log('备用pwa-install组件加载成功');
        };
    }</script>
    
    <!-- 使用pwa-install组件替换手动创建的按钮 -->
    <pwa-install 
        id="persistentAddButton"
        style="
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            z-index: 2147483647 !important;
            background: #2563eb !important;
            color: white !important;
            padding: 12px 20px !important;
            border: none !important;
            border-radius: 30px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            pointer-events: auto !important;
            will-change: transform !important;
            transform: translateZ(0) !important;
        "
        title="添加到桌面"
        icon="/icon-192x192.png"
        ios-text="点击分享按钮 → 添加到主屏幕"
        android-text="点击菜单 → 添加到主屏幕"
        unsupported-text="打开浏览器菜单，选择「添加到桌面」"
    >
        <i class="fa fa-mobile" aria-hidden="true"></i>
        <span>添加到桌面</span>
    </pwa-install>
    
    <!-- 添加调试脚本，监控pwa-install组件的事件 -->
    <script>
        // 全局变量存储beforeinstallprompt事件
        let deferredPrompt;
        
        // 直接在全局捕获beforeinstallprompt事件
        window.addEventListener('beforeinstallprompt', function(e) {
            console.log('全局捕获到beforeinstallprompt事件', e);
            // 阻止默认行为
            e.preventDefault();
            // 存储事件以供后续使用
            deferredPrompt = e;
            
            // 触发pwa-install组件的available事件
            const installButton = document.getElementById('persistentAddButton');
            if (installButton) {
                const availableEvent = new CustomEvent('available', {
                    detail: { promptEvent: e }
                });
                installButton.dispatchEvent(availableEvent);
                console.log('已手动触发pwa-install组件的available事件');
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const installButton = document.getElementById('persistentAddButton');
            if (installButton) {
                console.log('pwa-install组件已加载');
                
                // 监控组件状态变化
                installButton.addEventListener('available', function() {
                    console.log('PWA安装已可用');
                    // 显示按钮（如果被隐藏）
                    installButton.style.display = 'flex';
                });
                
                installButton.addEventListener('install', function() {
                    console.log('用户点击了安装按钮');
                    // 如果有存储的beforeinstallprompt事件，手动触发它
                    if (deferredPrompt) {
                        console.log('手动触发存储的beforeinstallprompt事件');
                        deferredPrompt.prompt();
                        
                        // 等待用户响应
                        deferredPrompt.userChoice.then((choiceResult) => {
                            console.log('用户选择:', choiceResult.outcome);
                            // 重置deferredPrompt变量
                            deferredPrompt = null;
                        });
                    }
                });
                
                installButton.addEventListener('installed', function() {
                    console.log('应用已成功安装');
                });
                
                // 额外添加点击事件监听器作为后备
                installButton.addEventListener('click', function() {
                    console.log('按钮被点击 - 后备处理');
                    if (deferredPrompt) {
                        console.log('点击事件触发存储的beforeinstallprompt事件');
                        deferredPrompt.prompt();
                    } else {
                        console.log('没有可用的beforeinstallprompt事件，显示设备特定指引');
                        showDeviceSpecificInstructions();
                    }
                });
            } else {
                console.log('未找到pwa-install组件');
            }
        });
    </script>
    
    <!-- 降级方案：如果组件仍不可用，创建备用按钮 -->
    <script>setTimeout(function() {
        if (typeof customElements.get('pwa-install') === 'undefined') {
            console.log('pwa-install组件不可用，创建备用按钮');
            const button = document.createElement('button');
            button.id = 'persistentAddButton';
            button.innerHTML = '<i class="fa fa-mobile" aria-hidden="true"></i><span>添加到桌面</span>';
            button.style.cssText = `
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                z-index: 2147483647 !important;
                background: #2563eb !important;
                color: white !important;
                padding: 12px 20px !important;
                border: none !important;
                border-radius: 30px !important;
                cursor: pointer !important;
                font-size: 14px !important;
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                pointer-events: auto !important;
                will-change: transform !important;
                transform: translateZ(0) !important;
            `;
            button.onclick = function() {
                if (deviceInfo.isMobile) {
                    showGenericInstructions();
                }
            };
            document.body.appendChild(button);
        }
    }, 1000);</script>

    <script>
    // 设备检测逻辑（复用原有的设备识别）
    const deviceInfo = {
        isXiaomi: /mi\s|xiaomi|redmi/i.test(navigator.userAgent),
        isHuawei: /huawei|honor/i.test(navigator.userAgent),
        isVivo: /vivo/i.test(navigator.userAgent),
        isOppo: /oppo|realme/i.test(navigator.userAgent),
        isApple: /iphone|ipad|ipod/i.test(navigator.userAgent),
        isDefaultBrowser: function() {
            return (this.isXiaomi && /miuibrowser/i.test(navigator.userAgent)) ||
                   (this.isHuawei && /huaweibrowser/i.test(navigator.userAgent)) ||
                   (this.isVivo && /vivobrowser/i.test(navigator.userAgent)) ||
                   (this.isOppo && /oppobrowser/i.test(navigator.userAgent));
        },
        isChrome: /chrome/i.test(navigator.userAgent) && /google inc/.test(navigator.vendor),
        isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
        isMobile: /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
    };

    // 根据设备类型显示特定的添加指引
    function showDeviceSpecificInstructions() {
        let instructions = "";
        
        // 小米设备
        if (deviceInfo.isXiaomi) {
            if (deviceInfo.isDefaultBrowser()) {
                instructions = "小米手机（默认浏览器）：\n1. 点击底部菜单按钮\n2. 选择'添加至桌面'\n3. 点击'确定'完成添加";
            } else if (deviceInfo.isChrome) {
                instructions = "小米手机（Chrome浏览器）：\n1. 点击右上角三个点\n2. 选择'添加到主屏幕'\n3. 点击'添加'完成";
            } else {
                instructions = "小米手机：\n1. 打开浏览器菜单\n2. 寻找'添加到主屏幕'或'安装'选项\n3. 确认添加到桌面";
            }
        }
        // 华为设备
        else if (deviceInfo.isHuawei) {
            if (deviceInfo.isDefaultBrowser()) {
                instructions = "华为手机（默认浏览器）：\n1. 点击底部四个点按钮\n2. 选择'添加至桌面'\n3. 点击'确认'完成添加";
            } else if (deviceInfo.isChrome) {
                instructions = "华为手机（Chrome浏览器）：\n1. 点击右上角三个点\n2. 选择'添加到主屏幕'\n3. 点击'添加'完成";
            } else {
                instructions = "华为手机：\n1. 打开浏览器菜单\n2. 寻找'添加到主屏幕'或'安装'选项\n3. 确认添加到桌面";
            }
        }
        // Vivo设备
        else if (deviceInfo.isVivo) {
            if (deviceInfo.isDefaultBrowser()) {
                instructions = "Vivo手机（默认浏览器）：\n1. 点击底部菜单按钮\n2. 选择'添加到桌面'\n3. 点击'确定'完成添加";
            } else if (deviceInfo.isChrome) {
                instructions = "Vivo手机（Chrome浏览器）：\n1. 点击右上角三个点\n2. 选择'添加到主屏幕'\n3. 点击'添加'完成";
            } else {
                instructions = "Vivo手机：\n1. 打开浏览器菜单\n2. 寻找'添加到主屏幕'或'安装'选项\n3. 确认添加到桌面";
            }
        }
        // OPPO设备
        else if (deviceInfo.isOppo) {
            if (deviceInfo.isDefaultBrowser()) {
                instructions = "OPPO手机（默认浏览器）：\n1. 点击底部菜单按钮\n2. 选择'添加至桌面'\n3. 点击'确认'完成添加";
            } else if (deviceInfo.isChrome) {
                instructions = "OPPO手机（Chrome浏览器）：\n1. 点击右上角三个点\n2. 选择'添加到主屏幕'\n3. 点击'添加'完成";
            } else {
                instructions = "OPPO手机：\n1. 打开浏览器菜单\n2. 寻找'添加到主屏幕'或'安装'选项\n3. 确认添加到桌面";
            }
        }
        // iOS设备
        else if (deviceInfo.isApple) {
            if (deviceInfo.isSafari) {
                instructions = "苹果手机（Safari浏览器）：\n1. 点击底部分享按钮\n2. 滑动到底部，点击'添加到主屏幕'\n3. 点击'添加'完成";
            } else {
                instructions = "苹果手机：\n1. 点击浏览器菜单\n2. 寻找'添加到主屏幕'或'安装'选项\n3. 确认添加到桌面";
            }
        }
        // 其他安卓设备
        else if (deviceInfo.isChrome) {
            instructions = "Android手机（Chrome浏览器）：\n1. 点击右上角三个点\n2. 选择'添加到主屏幕'\n3. 点击'添加'完成";
        }
        // 通用指引
        else {
            instructions = "添加到桌面：\n1. 打开浏览器菜单\n2. 寻找'添加到主屏幕'或'安装'\n3. 确认添加到桌面";
        }
        
        alert(instructions);
    }
    
    // 通用指引 - 保留用于降级方案
    function showGenericInstructions() {
        const instructions = "1. 打开浏览器菜单\n2. 寻找'添加到主屏幕'或'安装'\n3. 确认添加到桌面";
        alert(`添加到桌面：\n${instructions}`);
    }

    // 3. 核心防御机制：按钮被删/隐藏就强制恢复 - 适配pwa-install组件
    function defendButton() {
        const button = document.getElementById('persistentAddButton');
        
        // 防御1：按钮被删除 → 立即重建
        if (!button) {
            // 优先创建pwa-install组件
            if (typeof customElements.get('pwa-install') !== 'undefined') {
                const newButton = document.createElement('pwa-install');
                newButton.id = 'persistentAddButton';
                newButton.innerHTML = '<i class="fa fa-mobile" aria-hidden="true"></i><span>添加到桌面</span>';
                newButton.setAttribute('title', '添加到桌面');
                newButton.setAttribute('icon', '/icon-192x192.png');
                newButton.setAttribute('ios-text', '点击分享按钮 → 添加到主屏幕');
                newButton.setAttribute('android-text', '点击菜单 → 添加到主屏幕');
                newButton.setAttribute('unsupported-text', '打开浏览器菜单，选择「添加到桌面」');
                
                // 添加事件监听器到重建的组件
                newButton.addEventListener('available', function() {
                    console.log('重建的PWA安装组件已可用');
                });
                
                newButton.addEventListener('install', function() {
                    console.log('用户点击了重建的安装按钮');
                });
                newButton.style.cssText = `
                    position: fixed !important;
                    top: 20px !important;
                    right: 20px !important;
                    z-index: 2147483647 !important;
                    background: #2563eb !important;
                    color: white !important;
                    padding: 12px 20px !important;
                    border: none !important;
                    border-radius: 30px !important;
                    cursor: pointer !important;
                    font-size: 14px !important;
                    display: flex !important;
                    align-items: center !important;
                    gap: 8px !important;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                    pointer-events: auto !important;
                    will-change: transform !important;
                    transform: translateZ(0) !important;
                `;
                document.body.appendChild(newButton);
                console.log('pwa-install组件被删除，已重建');
            } else {
                // 降级方案：创建普通按钮
                const newButton = document.createElement('button');
                newButton.id = 'persistentAddButton';
                newButton.innerHTML = '<i class="fa fa-mobile" aria-hidden="true"></i><span>添加到桌面</span>';
                newButton.style.cssText = `
                    position: fixed !important;
                    top: 20px !important;
                    right: 20px !important;
                    z-index: 2147483647 !important;
                    background: #2563eb !important;
                    color: white !important;
                    padding: 12px 20px !important;
                    border: none !important;
                    border-radius: 30px !important;
                    cursor: pointer !important;
                    font-size: 14px !important;
                    display: flex !important;
                    align-items: center !important;
                    gap: 8px !important;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                    pointer-events: auto !important;
                    will-change: transform !important;
                    transform: translateZ(0) !important;
                `;
                newButton.onclick = function() {
                    if (deviceInfo.isMobile) {
                        showGenericInstructions();
                    }
                };
                document.body.appendChild(newButton);
                console.log('备用按钮被删除，已重建');
            }
            return;
        }
        
        // 防御2：按钮被隐藏 → 强制显示
        if (button.style.display !== 'flex' || button.style.visibility === 'hidden' || button.style.opacity === '0') {
            button.style.display = 'flex !important';
            button.style.visibility = 'visible !important';
            button.style.opacity = '1 !important';
            console.log('按钮被隐藏，已强制显示');
        }
        
        // 防御3：层级被覆盖 → 重置最高层级
        if (parseInt(button.style.zIndex) < 2147483647) {
            button.style.zIndex = '2147483647 !important';
            console.log('层级被覆盖，已重置最高层级');
        }
    }

    // 4. 高频监控 + 触发点拦截
    // 4.1 每50ms检查一次（米多客任何操作都会被立即拦截）
    const checkInterval = setInterval(defendButton, 50);

    // 4.2 监听米多客可能操作DOM的时机（如脚本加载完成、窗口显示）
    window.addEventListener('load', () => {
        console.log("设备识别结果：", deviceInfo); // 查看设备识别是否正确
        defendButton(); // 页面加载完成后立即检查
        
        // 适配国内浏览器：为不同品牌设备自定义pwa-install组件的指引文本
        const installButton = document.querySelector('pwa-install');
        if (installButton) {
            // 小米设备自定义指引
            if (deviceInfo.isXiaomi) {
                installButton.setAttribute('android-text', deviceInfo.isDefaultBrowser() 
                    ? '点击底部菜单 → 添加至桌面 → 确定' 
                    : '点击菜单 → 添加到主屏幕');
            }
            // 华为设备自定义指引
            else if (deviceInfo.isHuawei) {
                installButton.setAttribute('android-text', deviceInfo.isDefaultBrowser() 
                    ? '点击底部四个点 → 添加至桌面 → 确认' 
                    : '点击菜单 → 添加到主屏幕');
            }
            // Vivo设备自定义指引
            else if (deviceInfo.isVivo) {
                installButton.setAttribute('android-text', deviceInfo.isDefaultBrowser() 
                    ? '点击底部菜单 → 添加到桌面 → 确定' 
                    : '点击菜单 → 添加到主屏幕');
            }
            // OPPO设备自定义指引
            else if (deviceInfo.isOppo) {
                installButton.setAttribute('android-text', deviceInfo.isDefaultBrowser() 
                    ? '点击底部菜单 → 添加至桌面 → 确认' 
                    : '点击菜单 → 添加到主屏幕');
            }
        }
        
        // 延迟1秒再检查一次（应对米多客延迟加载的情况）
        setTimeout(defendButton, 1000);
        
        // 检查是否已经安装（独立模式）
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('应用已在独立模式运行，无需显示安装按钮');
        }
    });

    // 监听显示模式变化 - 当应用从浏览器切换到独立模式时
    window.matchMedia('(display-mode: standalone)').addEventListener('change', (e) => {
        if (e.matches) {
            console.log('应用已切换到独立模式运行');
        }
    });

    // 4.3 监听米多客可能注入的iframe/弹窗事件
    document.addEventListener('DOMNodeInserted', (e) => {
        // 若米多客添加了新元素，立即检查按钮状态
        if (e.target.tagName === 'IFRAME' || e.target.className.includes('michat')) {
            defendButton();
        }
    });

    // 5. 防误删机制：重写可能删除按钮的DOM方法
    const originalRemoveChild = Node.prototype.removeChild;
    Node.prototype.removeChild = function(child) {
        if (child.id === 'persistentAddButton') {
            console.log('阻止米多客删除按钮');
            return child; // 假装删除，实际保留
        }
        return originalRemoveChild.call(this, child);
    };

    const originalSetAttribute = Element.prototype.setAttribute;
    Element.prototype.setAttribute = function(name, value) {
        if (this.id === 'persistentAddButton' && name === 'style' && 
            (value.includes('display:none') || value.includes('visibility:hidden'))) {
            console.log('阻止米多客隐藏按钮');
            return; // 忽略隐藏样式
        }
        return originalSetAttribute.call(this, name, value);
    };
    </script> 

    <!-- 注册Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>