<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 基本设置 -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>客服系统</title>
    
    <!-- 优先引入Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <!-- 性能优化 -->
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <meta name="format-detection" content="telephone=no">
    
    <!-- DNS预解析 -->
    <link rel="dns-prefetch" href="//mdclink.xianshangkefu.com">
    
    <!-- 提前建立连接 -->
    <link rel="preconnect" href="//mdclink.xianshangkefu.com" crossorigin>
</head>
<body>
    <!-- 在 <body> 中添加米多客手机样式容器 -->
    <div id="midokContainer" style="
        position: fixed;
        right: 20px;
        bottom: 80px;
        width: 320px;
        height: 568px;
        border: 10px solid #333;
        border-radius: 36px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        overflow: hidden;
        z-index: 2147483646; /* 低于自定义按钮的z-index */
    ">
        <!-- 手机顶部装饰 -->
        <div style="height: 40px; background: #333; position: relative;">
            <div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 120px; height: 20px; background: #000; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px;"></div>
        </div>
        <!-- Shadow DOM挂载点 -->
        <div id="midokMountPoint" style="height: calc(100% - 40px); background: #fff;"></div>
    </div>

    <!-- 米多客客服组件 - 使用Shadow DOM隔离 -->
    <script>
        // 重构米多客初始化，使用Shadow DOM隔离
        function initMidokChat() {
            try {
                const mountPoint = document.getElementById('midokMountPoint');
                const shadowRoot = mountPoint.attachShadow({ mode: 'closed' }); // 封闭模式，避免外部干扰

                // 注入米多客所需样式
                const style = document.createElement('style');
                style.textContent = `
                    /* 仅在Shadow内部生效的样式 */
                    @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css');
                `;
                shadowRoot.appendChild(style);

                // 加载米多客核心脚本
                const midokScript = document.createElement('script');
                midokScript.textContent = `
                    window._MICHAT = window._MICHAT || function () { (_MICHAT.a = _MICHAT.a || []).push(arguments) };
                    _MICHAT("cptid", "e773425b58e01513a5"); // 客服ID
                    _MICHAT("host", "mdclink.xianshangkefu.com");
                    _MICHAT("sound", false);
                    _MICHAT("preventDefault", false);
                    
                    const script = document.createElement('script');
                    script.src = "//mdclink.xianshangkefu.com/Web/js/loader.js";
                    script.async = true;
                    document.currentScript.parentNode.appendChild(script);
                `;
                shadowRoot.appendChild(midokScript);
                
                console.log('米多客客服组件已在Shadow DOM中初始化');
            } catch (e) {
                console.error('米多客隔离初始化失败:', e);
            }
        }

        // 页面加载后延迟初始化（避免阻塞）
        window.addEventListener('load', () => {
            setTimeout(initMidokChat, 3000); // 延迟3秒，确保页面其他元素加载完成
        });
    </script>
    
    <!-- 保留原有的“指标大礼包”按钮（确保z-index更高） -->
    <div id="giftPackageButton" 
        style="
            position: fixed !important;
            top: 50% !important;
            right: 20px !important;
            transform: translateY(-50%) !important;
            z-index: 2147483647 !important; /* 高于米多客容器 */
            background: linear-gradient(135deg, #4A90E2, #5C6BC0) !important;
            color: white !important;
            padding: 12px 20px !important;
            border: none !important;
            border-radius: 25px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-weight: bold !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            box-shadow: 0 4px 20px rgba(74, 144, 226, 0.4) !important;
            pointer-events: auto !important;
            will-change: transform !important;
            animation: subtleGlow 3s infinite alternate !important;
            min-width: 120px !important;
            transition: all 0.3s ease !important;
        "
    >
        <i class="fa fa-bar-chart" aria-hidden="true" style="font-size: 16px !important;"></i>
        <span>指标大礼包</span>
    </div>
    
    <!-- 为礼包按钮添加动画和样式 -->
    <style>
        @keyframes subtleGlow {
            0% {
                box-shadow: 0 4px 20px rgba(74, 144, 226, 0.4);
                background: linear-gradient(135deg, #4A90E2, #5C6BC0);
            }
            100% {
                box-shadow: 0 6px 25px rgba(74, 144, 226, 0.6);
                background: linear-gradient(135deg, #5BA3F3, #6D82E3);
            }
        }
        
        #giftPackageButton:hover {
            transform: scale(1.05) translateY(-50%) !important;
            box-shadow: 0 8px 30px rgba(74, 144, 226, 0.7) !important;
        }
        
        #giftPackageButton:active {
            transform: scale(0.98) translateY(-50%) !important;
        }
        
        /* 响应式设计：在小屏幕上自动调整样式 */
        @media (max-width: 768px) {
            #giftPackageButton {
                right: 10px !important;
                font-size: 12px !important;
                padding: 10px 16px !important;
                min-width: auto !important;
            }
        }
    </style>
    
    <!-- 礼包按钮点击事件 -->
    <script>
        // 页面加载后跳转到指标大礼包页面
        document.addEventListener('DOMContentLoaded', function() {
            // 礼包按钮事件
            const giftButton = document.getElementById('giftPackageButton');
            if (giftButton) {
                giftButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    window.location.replace('qiliantong-download.html');
                });
            }
        });
    </script>
    
    <!-- 客服通道保存功能 -->
    <script>
        // 页面加载完成后创建客服通道保存按钮
        document.addEventListener('DOMContentLoaded', function() {
            createSaveChannelButton();
        });
        
        // 创建客服通道保存按钮
        function createSaveChannelButton() {
            // 创建按钮元素
            const saveButton = document.createElement('div');
            saveButton.id = 'saveChannelButton';
            saveButton.innerHTML = '<i class="fa fa-link" aria-hidden="true"></i> 保存客服通道';
            
            // 设置样式
            saveButton.style.cssText = `
                position: fixed !important;
                bottom: 20px !important;
                left: 20px !important;
                z-index: 2147483647 !important;
                background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
                color: white !important;
                padding: 12px 18px !important;
                border: none !important;
                border-radius: 25px !important;
                cursor: pointer !important;
                font-size: 12px !important;
                font-weight: bold !important;
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                box-shadow: 0 4px 20px rgba(155, 89, 182, 0.4) !important;
                pointer-events: auto !important;
                transition: all 0.3s ease !important;
                min-width: 120px !important;
            `;
            
            // 添加点击事件
            saveButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // 获取当前域名（包含协议和主机名）
                const currentDomain = window.location.origin;
                
                try {
                    // 提示用户
                    showNotification('请手动记录以下域名:\n' + currentDomain, 'info');
                } catch (error) {
                    alert('请手动记录以下域名:\n' + currentDomain);
                }
            });
            
            // 添加到页面
            document.body.appendChild(saveButton);
        }
        
        // 通用通知函数
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.id = 'customNotification';
            
            // 设置样式
            let bgColor = '#3498db'; // 默认信息颜色
            if (type === 'success') bgColor = '#2ecc71';
            if (type === 'error') bgColor = '#e74c3c';
            
            notification.style.cssText = `
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                z-index: 2147483647 !important;
                background: ${bgColor} !important;
                color: white !important;
                padding: 20px !important;
                border-radius: 10px !important;
                font-size: 14px !important;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
                max-width: 90% !important;
                text-align: center !important;
                word-break: break-word !important;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 3秒后自动隐藏
            setTimeout(() => {
                // 添加淡出动画
                notification.style.transition = 'opacity 0.5s ease !important';
                notification.style.opacity = '0 !important';
                
                // 动画结束后移除元素
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        }
    </script>
    
    <!-- 核心防御机制：无敌模式 -->
    <script>
        // 无敌模式：完整的防御机制
        function enableInvincibleMode() {
            // 存储按钮的基础配置
            const buttonConfigs = {
                giftPackageButton: {
                    id: 'giftPackageButton',
                    html: '<i class="fa fa-bar-chart" aria-hidden="true" style="font-size: 16px !important;"></i><span>指标大礼包</span>',
                    style: `
                        position: fixed !important;
                        top: 50% !important;
                        right: 20px !important;
                        transform: translateY(-50%) !important;
                        z-index: 2147483647 !important; // 必须高于米多客容器
                        background: linear-gradient(135deg, #4A90E2, #5C6BC0) !important;
                        color: white !important;
                        padding: 12px 20px !important;
                        border: none !important;
                        border-radius: 25px !important;
                        cursor: pointer !important;
                        font-size: 14px !important;
                        font-weight: bold !important;
                        display: flex !important;
                        align-items: center !important;
                        gap: 8px !important;
                        box-shadow: 0 4px 20px rgba(74, 144, 226, 0.4) !important;
                        pointer-events: auto !important;
                        will-change: transform !important;
                        animation: subtleGlow 3s infinite alternate !important;
                        min-width: 120px !important;
                        transition: all 0.3s ease !important;
                        user-select: none !important;
                        -webkit-user-select: none !important;
                        -moz-user-select: none !important;
                        -ms-user-select: none !important;
                    `,
                    onClick: function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        window.location.href = 'qiliantong-download.html';
                    }
                },
                saveChannelButton: {
                    id: 'saveChannelButton',
                    html: '<i class="fa fa-link" aria-hidden="true"></i> 保存客服通道',
                    style: `
                        position: fixed !important;
                        bottom: 20px !important;
                        left: 20px !important;
                        z-index: 2147483647 !important;
                        background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
                        color: white !important;
                        padding: 12px 18px !important;
                        border: none !important;
                        border-radius: 25px !important;
                        cursor: pointer !important;
                        font-size: 12px !important;
                        font-weight: bold !important;
                        display: flex !important;
                        align-items: center !important;
                        gap: 8px !important;
                        box-shadow: 0 4px 20px rgba(155, 89, 182, 0.4) !important;
                        pointer-events: auto !important;
                        transition: all 0.3s ease !important;
                        min-width: 120px !important;
                        user-select: none !important;
                        -webkit-user-select: none !important;
                        -moz-user-select: none !important;
                        -ms-user-select: none !important;
                    `,
                    onClick: function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // 固定的客服通道链接
                        const customDomain = 'https://jiuzhougroup.vip/';
                        
                        try {
                            // 提示用户
                            showNotification('客服通道链接:\n' + customDomain, 'info');
                        } catch (error) {
                            alert('客服通道链接:\n' + customDomain);
                        }
                    }
                }
            };

            // 创建或恢复按钮
            function createOrRecoverButton(config) {
                let button = document.getElementById(config.id);
                
                if (!button) {
                    // 按钮不存在，创建新按钮
                    button = document.createElement('div');
                    button.id = config.id;
                    button.innerHTML = config.html;
                    button.style.cssText = config.style;
                    
                    // 添加点击事件
                    button.addEventListener('click', config.onClick);
                    
                    // 添加到页面
                    document.body.appendChild(button);
                } else {
                    // 按钮存在，重置属性
                    button.innerHTML = config.html;
                    button.style.cssText = config.style;
                    
                    // 确保点击事件有效 - 使用标准JavaScript方法
                    // 移除所有现有事件监听器的最佳方式是克隆元素
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    newButton.addEventListener('click', config.onClick);
                }
                
                return button;
            }

            // 核心防御函数
            function defendButtons() {
                // 为每个按钮创建或恢复
                for (const key in buttonConfigs) {
                    if (buttonConfigs.hasOwnProperty(key)) {
                        const button = createOrRecoverButton(buttonConfigs[key]);
                        
                        // 无敌保护：强制显示和最高层级
                        button.style.display = 'flex !important';
                        button.style.visibility = 'visible !important';
                        button.style.opacity = '1 !important';
                        button.style.zIndex = '2147483647 !important';
                        button.style.position = 'fixed !important';
                        button.style.pointerEvents = 'auto !important';
                        button.style.userSelect = 'none !important';
                        button.style.webkitUserSelect = 'none !important';
                        button.style.mozUserSelect = 'none !important';
                        button.style.msUserSelect = 'none !important';
                        
                        // 防止通过CSS变量覆盖
                        button.style.setProperty('--display-override', 'flex', 'important');
                        button.style.setProperty('--visibility-override', 'visible', 'important');
                        button.style.setProperty('--opacity-override', '1', 'important');
                    }
                }
            }

            // 重写DOM方法，防止按钮被删除或修改
            function overrideDOMMethods() {
                // 保存原始方法
                const originalRemoveChild = Node.prototype.removeChild;
                const originalRemove = Element.prototype.remove;
                const originalSetAttribute = Element.prototype.setAttribute;
                const originalRemoveAttribute = Element.prototype.removeAttribute;
                const originalStyleSetProperty = CSSStyleDeclaration.prototype.setProperty;
                
                // 重写removeChild方法
                Node.prototype.removeChild = function(child) {
                    // 检查是否是受保护的按钮
                        for (const key in buttonConfigs) {
                            if (buttonConfigs.hasOwnProperty(key) && 
                                child && child.id === buttonConfigs[key].id) {
                                // 尝试移除受保护按钮，阻止操作
                                return child; // 不执行移除操作
                            }
                        }
                        
                        // 允许米多客客服组件相关的DOM操作
                        if (child && (child.className && child.className.includes('mdc-chat') || 
                            child.id && child.id.includes('mdc-'))) {
                            return originalRemoveChild.apply(this, arguments);
                        }
                    // 其他元素正常处理
                    return originalRemoveChild.apply(this, arguments);
                };
                
                // 重写remove方法
                Element.prototype.remove = function() {
                    // 检查是否是受保护的按钮
                        for (const key in buttonConfigs) {
                            if (buttonConfigs.hasOwnProperty(key) && 
                                this.id === buttonConfigs[key].id) {
                                // 尝试移除受保护按钮，阻止操作
                                return; // 不执行移除操作
                            }
                        }
                        
                        // 允许米多客客服组件相关的DOM操作
                        if (this.className && this.className.includes('mdc-chat') || 
                            this.id && this.id.includes('mdc-')) {
                            return originalRemove.apply(this, arguments);
                        }
                    // 其他元素正常处理
                    return originalRemove.apply(this, arguments);
                };
                
                // 重写setAttribute方法
                Element.prototype.setAttribute = function(name, value) {
                    // 检查是否是受保护的按钮且尝试修改关键属性
                        for (const key in buttonConfigs) {
                            if (buttonConfigs.hasOwnProperty(key) && 
                                this.id === buttonConfigs[key].id && 
                                (name === 'style' || name === 'class' || name === 'id')) {
                                // 尝试修改受保护按钮的关键属性，阻止操作
                                return; // 不执行修改操作
                            }
                        }
                        
                        // 允许米多客客服组件相关的DOM操作
                        if (this.className && this.className.includes('mdc-chat') || 
                            this.id && this.id.includes('mdc-')) {
                            return originalSetAttribute.apply(this, arguments);
                        }
                    // 其他元素正常处理
                    return originalSetAttribute.apply(this, arguments);
                };
                
                // 重写removeAttribute方法
                Element.prototype.removeAttribute = function(name) {
                    // 检查是否是受保护的按钮且尝试移除关键属性
                        for (const key in buttonConfigs) {
                            if (buttonConfigs.hasOwnProperty(key) && 
                                this.id === buttonConfigs[key].id && 
                                (name === 'style' || name === 'id')) {
                                // 尝试移除受保护按钮的关键属性，阻止操作
                                return; // 不执行移除操作
                            }
                        }
                        
                        // 允许米多客客服组件相关的DOM操作
                        if (this.className && this.className.includes('mdc-chat') || 
                            this.id && this.id.includes('mdc-')) {
                            return originalRemoveAttribute.apply(this, arguments);
                        }
                    // 其他元素正常处理
                    return originalRemoveAttribute.apply(this, arguments);
                };
                
                // 重写style.setProperty方法
                CSSStyleDeclaration.prototype.setProperty = function(property, value, priority) {
                    // 检查是否是尝试修改受保护按钮的关键样式
                        const element = this.element || (this._element || null);
                        if (element) {
                            for (const key in buttonConfigs) {
                                if (buttonConfigs.hasOwnProperty(key) && 
                                    element.id === buttonConfigs[key].id && 
                                    (property.includes('display') || 
                                     property.includes('visibility') || 
                                     property.includes('opacity') || 
                                     property.includes('z-index') || 
                                     property.includes('position') || 
                                     property.includes('pointer-events'))) {
                                    // 尝试修改受保护按钮的关键样式，阻止操作
                                    return; // 不执行修改操作
                                }
                            }
                            
                            // 允许米多客客服组件相关的DOM操作
                            if (element.className && element.className.includes('mdc-chat') || 
                                element.id && element.id.includes('mdc-')) {
                                return originalStyleSetProperty.apply(this, arguments);
                            }
                        }
                    // 其他样式正常处理
                    return originalStyleSetProperty.apply(this, arguments);
                };
            }

            // 监听DOM变化
            function observeDOMChanges() {
                // 创建MutationObserver实例
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        // 检查是否有节点被移除
                        if (mutation.type === 'childList' && mutation.removedNodes.length > 0) {
                            mutation.removedNodes.forEach(function(node) {
                                // 检查是否是受保护的按钮
                                if (node.nodeType === 1) { // 元素节点
                                    for (const key in buttonConfigs) {
                                        if (buttonConfigs.hasOwnProperty(key) && 
                                            node.id === buttonConfigs[key].id) {
                                            // 受保护的按钮被移除，立即恢复
                                            setTimeout(defendButtons, 0);
                                        }
                                    }
                                }
                            });
                        }
                        
                        // 检查是否有节点属性被修改
                        if (mutation.type === 'attributes' && mutation.target.nodeType === 1) {
                            // 检查是否是受保护的按钮
                            for (const key in buttonConfigs) {
                                if (buttonConfigs.hasOwnProperty(key) && 
                                    mutation.target.id === buttonConfigs[key].id && 
                                    (mutation.attributeName === 'style' || 
                                     mutation.attributeName === 'class')) {
                                    // 受保护的按钮属性被修改，立即恢复
                                    setTimeout(defendButtons, 0);
                                }
                            }
                        }
                    });
                });
                
                // 配置观察选项
                const config = {
                    childList: true,
                    attributes: true,
                    subtree: true,
                    attributeOldValue: true,
                    characterData: true,
                    characterDataOldValue: true
                };
                
                // 开始观察document.body
                if (document.body) {
                    observer.observe(document.body, config);
                } else {
                    // 如果body还不存在，等待DOMContentLoaded
                    document.addEventListener('DOMContentLoaded', function() {
                        observer.observe(document.body, config);
                    });
                }
            }

            // 初始化无敌模式
            try {
                // 1. 重写DOM方法
                overrideDOMMethods();
                
                // 2. 设置定期检查（高频）
                setInterval(defendButtons, 100); // 100ms检查一次
                
                // 3. 添加DOM变化监听
                observeDOMChanges();
                
                // 4. 立即执行一次防御
                defendButtons();
            } catch (e) {
                // 静默处理异常，确保不影响页面功能
            }
        }

        // 启动无敌模式
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(enableInvincibleMode, 1000); // 延迟1秒启动，确保页面元素加载完成
        });
    </script>
</body>
</html>