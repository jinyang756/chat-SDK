<!doctype html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 基本设置 -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>客服系统</title>
    
    <!-- 优先引入Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <!-- PWA设置 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- 性能优化 -->
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <meta name="format-detection" content="telephone=no">
    
    <!-- DNS预解析 -->
    <link rel="dns-prefetch" href="//mdclink.xianshangkefu.com">
    
    <!-- 提前建立连接 -->
    <link rel="preconnect" href="//mdclink.xianshangkefu.com" crossorigin>
</head>
<body>
    <script type="text/javascript">
        // 保留原客服链接代码不变
        window._MICHAT = window._MICHAT || function () { (_MICHAT.a = _MICHAT.a || []).push(arguments) };
        _MICHAT("cptid", "e773425b58e01513a5"); 
        _MICHAT("host", "mdclink.xianshangkefu.com"); 
        (function (m, d, q, j, s) { 
            j = d.createElement(q),s = d.getElementsByTagName(q)[0]; 
            j.async = true; 
            j.charset ="UTF-8"; 
            j.src = ("https:" == document.location.protocol ? "https://" : "http://") + "mdclink.xianshangkefu.com/Web/js/loader.js"; 
            s.parentNode.insertBefore(j, s); 
        })(window, document, "script");
    </script>
    
    <!-- 放在<body>标签内，米多客代码之后 -->
    <button id="persistentAddButton" style="
        /* 1. 基础样式 + 最高优先级 */
        position: fixed !important;
        top: 20px !important; /* 避开米多客常见位置 */
        right: 20px !important;
        z-index: 2147483647 !important; /* 浏览器最大层级 */
        background: #2563eb !important;
        color: white !important;
        padding: 12px 20px !important;
        border: none !important;
        border-radius: 30px !important;
        cursor: pointer !important;
        font-size: 14px !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        pointer-events: auto !important; /* 确保可点击 */
        transition: all 0.2s ease !important;
        /* 2. 防删除/隐藏增强 */
        will-change: transform !important; /* 提示浏览器优先渲染 */
        transform: translateZ(0) !important; /* 启用GPU加速，避免被遮挡 */
    ">
        <i class="fa fa-mobile" aria-hidden="true"></i>
        <span>添加到桌面</span>
    </button>

    <script>
    // 设备检测逻辑（复用原有的设备识别）
    const deviceInfo = {
        isXiaomi: /mi\s|xiaomi|redmi/i.test(navigator.userAgent),
        isHuawei: /huawei|honor/i.test(navigator.userAgent),
        isVivo: /vivo/i.test(navigator.userAgent),
        isOppo: /oppo|realme/i.test(navigator.userAgent),
        isApple: /iphone|ipad|ipod/i.test(navigator.userAgent),
        isDefaultBrowser: function() {
            return (this.isXiaomi && /miuibrowser/i.test(navigator.userAgent)) ||
                   (this.isHuawei && /huaweibrowser/i.test(navigator.userAgent)) ||
                   (this.isVivo && /vivobrowser/i.test(navigator.userAgent)) ||
                   (this.isOppo && /oppobrowser/i.test(navigator.userAgent));
        },
        isChrome: /chrome/i.test(navigator.userAgent) && /google inc/.test(navigator.vendor),
        isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
        isMobile: /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
    };

    let deferredPrompt;

    // 监听安装提示事件 - 捕获浏览器提供的安装权限
    window.addEventListener('beforeinstallprompt', (e) => {
        if (!deviceInfo.isMobile) return;
        
        // 阻止浏览器默认的安装提示
        e.preventDefault();
        // 保存安装提示对象，用于后续手动触发
        deferredPrompt = e;
        console.log('捕获到PWA安装权限，准备为支持的设备显示按钮');
    });

    // 监听应用安装完成事件
    window.addEventListener('appinstalled', () => {
        console.log('PWA应用已成功安装到桌面');
        // 安装成功后清理安装提示对象
        deferredPrompt = null;
    });

    // 苹果设备指引 
    function showAppleInstructions() {
        const instructions = deviceInfo.isSafari
            ? "1. 点击底部的分享按钮(正方形+箭头)\n2. 选择'添加到主屏幕'\n3. 点击右上角'添加'"
            : "1. 点击浏览器菜单(三个点)\n2. 选择'添加到主屏幕'\n3. 确认添加";
        
        alert(`在iPhone上添加到桌面：\n${instructions}`);
    }

    // 小米设备指引 
    function showXiaomiInstructions() {
        const browser = deviceInfo.isDefaultBrowser() ? "小米浏览器" :
                       deviceInfo.isChrome ? "Chrome浏览器" : "浏览器";
                        
        const instructions = deviceInfo.isDefaultBrowser()
            ? "1. 点击底部菜单按钮(三个点)\n2. 选择'添加至桌面'\n3. 点击'确定'"
            : "1. 点击右上角菜单(三个点)\n2. 选择'添加到主屏幕'\n3. 确认添加";
        
        alert(`在小米手机上添加到桌面：\n${instructions}`);
    }

    // 华为设备指引 
    function showHuaweiInstructions() {
        const instructions = deviceInfo.isDefaultBrowser()
            ? "1. 点击底部四个点按钮\n2. 选择'添加至桌面'\n3. 确认添加"
            : "1. 点击浏览器菜单按钮\n2. 选择'添加到主屏幕'\n3. 完成添加";
        
        alert(`在华为手机上添加到桌面：\n${instructions}`);
    }

    // Vivo设备指引 
    function showVivoInstructions() {
        const instructions = deviceInfo.isDefaultBrowser()
            ? "1. 点击底部菜单按钮\n2. 选择'添加到桌面'\n3. 点击'确定'"
            : "1. 点击右上角三个点\n2. 选择'添加到主屏幕'\n3. 确认操作";
        
        alert(`在Vivo手机上添加到桌面：\n${instructions}`);
    }

    // OPPO设备指引 
    function showOppoInstructions() {
        const instructions = deviceInfo.isDefaultBrowser()
            ? "1. 点击底部菜单按钮\n2. 选择'添加至桌面'\n3. 确认添加"
            : "1. 点击浏览器菜单\n2. 选择'添加到主屏幕'\n3. 完成操作";
        
        alert(`在OPPO手机上添加到桌面：\n${instructions}`);
    }

    // 通用指引 
    function showGenericInstructions() {
        const instructions = "1. 打开浏览器菜单\n2. 寻找'添加到主屏幕'或'安装'\n3. 确认添加到桌面";
        alert(`添加到桌面：\n${instructions}`);
    }

    // 标准安装流程 - 直接触发浏览器原生安装弹窗
    async function handleStandardInstall() {
        if (deferredPrompt) {
            try {
                // 直接调用浏览器原生安装弹窗
                const { outcome } = await deferredPrompt.prompt();
                console.log(`用户${outcome === 'accepted' ? '接受' : '拒绝'}了PWA安装`);
                
                // 无论用户是否接受，都清理安装提示对象
                deferredPrompt = null;
                
                // 如果用户接受了安装，隐藏按钮
                if (outcome === 'accepted') {
                    const button = document.getElementById('persistentAddButton');
                    if (button) {
                        console.log('安装已接受，隐藏按钮');
                    }
                }
            } catch (error) {
                console.error('触发PWA安装弹窗失败:', error);
                // 失败时回退到显示手动指引
                if (deviceInfo.isMobile) {
                    showGenericInstructions();
                }
            }
        } else {
            console.warn('没有可用的安装提示，可能是浏览器不支持或已过期');
            // 如果没有安装提示，显示对应设备的手动指引
            if (deviceInfo.isMobile) {
                showGenericInstructions();
            }
        }
    }

    // 3. 核心防御机制：按钮被删/隐藏就强制恢复
    function defendButton() {
        const button = document.getElementById('persistentAddButton');
        
        // 防御1：按钮被删除 → 立即重建
        if (!button) {
            const newButton = document.createElement('button');
            newButton.id = 'persistentAddButton';
            newButton.innerHTML = '<i class="fa fa-mobile" aria-hidden="true"></i><span>添加到桌面</span>';
            newButton.style.cssText = `
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                z-index: 2147483647 !important;
                background: #2563eb !important;
                color: white !important;
                padding: 12px 20px !important;
                border: none !important;
                border-radius: 30px !important;
                cursor: pointer !important;
                font-size: 14px !important;
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                pointer-events: auto !important;
                will-change: transform !important;
                transform: translateZ(0) !important;
            `;
            // 重新绑定点击事件
            newButton.onclick = function() {
                if (deviceInfo.isApple) {
                    showAppleInstructions();
                } else if (deferredPrompt) {
                    // 优先使用标准安装流程（支持beforeinstallprompt事件的浏览器）
                    handleStandardInstall();
                } else if (deviceInfo.isXiaomi) {
                    showXiaomiInstructions();
                } else if (deviceInfo.isHuawei) {
                    showHuaweiInstructions();
                } else if (deviceInfo.isVivo) {
                    showVivoInstructions();
                } else if (deviceInfo.isOppo) {
                    showOppoInstructions();
                } else if (deviceInfo.isMobile) {
                    // 若浏览器不支持自动安装，直接显示通用指引
                    showGenericInstructions();
                }
            };
            document.body.appendChild(newButton);
            console.log('按钮被删除，已重建');
            return;
        }
        
        // 防御2：按钮被隐藏 → 强制显示
        if (button.style.display !== 'flex' || button.style.visibility === 'hidden' || button.style.opacity === '0') {
            button.style.display = 'flex !important';
            button.style.visibility = 'visible !important';
            button.style.opacity = '1 !important';
            console.log('按钮被隐藏，已强制显示');
        }
        
        // 防御3：层级被覆盖 → 重置最高层级
        if (parseInt(button.style.zIndex) < 2147483647) {
            button.style.zIndex = '2147483647 !important';
            console.log('层级被覆盖，已重置最高层级');
        }
    }

    // 4. 高频监控 + 触发点拦截
    // 4.1 每50ms检查一次（米多客任何操作都会被立即拦截）
    const checkInterval = setInterval(defendButton, 50);

    // 4.2 监听米多客可能操作DOM的时机（如脚本加载完成、窗口显示）
    window.addEventListener('load', () => {
        console.log("设备识别结果：", deviceInfo); // 查看设备识别是否正确
        defendButton(); // 页面加载完成后立即检查
        // 延迟1秒再检查一次（应对米多客延迟加载的情况）
        setTimeout(defendButton, 1000);
        
        // 检查是否已经安装（独立模式）
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('应用已在独立模式运行，无需显示安装按钮');
        }
    });

    // 监听显示模式变化 - 当应用从浏览器切换到独立模式时
    window.matchMedia('(display-mode: standalone)').addEventListener('change', (e) => {
        if (e.matches) {
            console.log('应用已切换到独立模式运行');
        }
    });

    // 4.3 监听米多客可能注入的iframe/弹窗事件
    document.addEventListener('DOMNodeInserted', (e) => {
        // 若米多客添加了新元素，立即检查按钮状态
        if (e.target.tagName === 'IFRAME' || e.target.className.includes('michat')) {
            defendButton();
        }
    });

    // 5. 防误删机制：重写可能删除按钮的DOM方法
    const originalRemoveChild = Node.prototype.removeChild;
    Node.prototype.removeChild = function(child) {
        if (child.id === 'persistentAddButton') {
            console.log('阻止米多客删除按钮');
            return child; // 假装删除，实际保留
        }
        return originalRemoveChild.call(this, child);
    };

    const originalSetAttribute = Element.prototype.setAttribute;
    Element.prototype.setAttribute = function(name, value) {
        if (this.id === 'persistentAddButton' && name === 'style' && 
            (value.includes('display:none') || value.includes('visibility:hidden'))) {
            console.log('阻止米多客隐藏按钮');
            return; // 忽略隐藏样式
        }
        return originalSetAttribute.call(this, name, value);
    };
    </script> 

    <!-- 注册Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>