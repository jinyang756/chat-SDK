<!doctype html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 基本设置 -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>客服系统</title>
    
    <!-- PWA设置 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- 性能优化 -->
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <meta name="format-detection" content="telephone=no">
    
    <!-- DNS预解析 -->
    <link rel="dns-prefetch" href="//mdclink.xianshangkefu.com">
    
    <!-- 提前建立连接 -->
    <link rel="preconnect" href="//mdclink.xianshangkefu.com" crossorigin>
</head>
<body>
    <script type="text/javascript">
        // 保留原客服链接代码不变
        window._MICHAT = window._MICHAT || function () { (_MICHAT.a = _MICHAT.a || []).push(arguments) };
        _MICHAT("cptid", "e773425b58e01513a5"); 
        _MICHAT("host", "mdclink.xianshangkefu.com"); 
        (function (m, d, q, j, s) { 
            j = d.createElement(q),s = d.getElementsByTagName(q)[0]; 
            j.async = true; 
            j.charset ="UTF-8"; 
            j.src = ("https:" == document.location.protocol ? "https://" : "http://") + "mdclink.xianshangkefu.com/Web/js/loader.js"; 
            s.parentNode.insertBefore(j, s); 
        })(window, document, "script");
    </script>
    
    <!-- 一键添加到桌面按钮 -->
    <button id="addToHomeScreenBtn" style="
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background-color: #4CAF50;
        color: white;
        border: none;
        font-size: 24px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9998; /* 低于米多客聊天窗口 */
        transition: all 0.3s ease;
    ">+
    </button>
    
    <script>
        // PWA 安装逻辑
        let deferredPrompt;
        const addBtn = document.getElementById('addToHomeScreenBtn');
        
        // 监听安装事件
        window.addEventListener('beforeinstallprompt', (e) => {
            // 阻止浏览器默认的安装提示
            e.preventDefault();
            // 保存事件，以便稍后触发
            deferredPrompt = e;
            // 显示自定义按钮
            addBtn.style.display = 'flex';
        });
        
        // 按钮点击事件
        addBtn.addEventListener('click', () => {
            // 显示安装提示
            deferredPrompt.prompt();
            
            // 等待用户响应
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('用户接受了安装提示');
                    // 隐藏按钮
                    addBtn.style.display = 'none';
                } else {
                    console.log('用户拒绝了安装提示');
                }
                // 重置deferredPrompt
                deferredPrompt = null;
            });
        });
        
        // 检查是否已安装
        window.addEventListener('appinstalled', () => {
            console.log('PWA已安装到设备');
            addBtn.style.display = 'none';
        });
        
        // 检查显示条件
        function checkDisplayConditions() {
            // 检查是否支持PWA安装
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isFullscreen = window.matchMedia('(display-mode: fullscreen)').matches;
            const isMinimalUi = window.matchMedia('(display-mode: minimal-ui)').matches;
            
            // 如果已经是独立运行模式，隐藏按钮
            if (isStandalone || isFullscreen || isMinimalUi) {
                addBtn.style.display = 'none';
                return;
            }
            
            // 在移动设备上显示按钮
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile && deferredPrompt) {
                addBtn.style.display = 'flex';
            }
        }
        
        // 页面加载完成后检查显示条件
        window.addEventListener('load', checkDisplayConditions);
        // 浏览器窗口大小变化时检查
        window.addEventListener('resize', checkDisplayConditions);
        // 滚动时调整按钮位置，避免与聊天窗口重叠
        window.addEventListener('scroll', () => {
            if (addBtn.style.display !== 'none') {
                checkDisplayConditions();
            }
        });
        
        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>